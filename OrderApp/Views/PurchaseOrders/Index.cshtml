@model IEnumerable<OrderApp.Models.PurchaseOrder>

@{
    ViewData["Title"] = "Purchase Orders";
}

<main class="app-main">
    <!--begin::App Content Header-->
    <div class="app-content-header">
        <!--begin::Container-->
        <div class="container-fluid">
            <!--begin::Row-->
            <div class="row">
                <div class="col-sm-6">
                    <h3 class="mb-0">Purchase Orders</h3>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-end">
                        <li class="breadcrumb-item"><a href="#">Home</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Purchase Orders</li>
                    </ol>
                </div>
            </div>
            <!--end::Row-->
        </div>
        <!--end::Container-->
    </div>
    <!--end::App Content Header-->
    <!--begin::App Content-->
    <div class="app-content">
        <!--begin::Container-->
        <div class="container-fluid">
            <!--begin::Row-->
            <div class="row">
                <div class="col-md-12">

                    <div class="card mb-4">
                        <div class="card-header">

                            <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#AddOrEdit">Create New</a>

                        </div>
                        <!-- /.card-header -->
                        <div class="card-body p-0">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Customer</th>
                                        <th>Delivery Dte</th>
                                        <th>Status</th>
                                        <th>Amount Due</th>
                                        <th>IsActive</th>
                                        <th style="width: 40px"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var po in Model)
                                    {
                                        <tr>
                                            <td>@po.Customer.FullName</td>
                                            <td>@po.DateOfDelivery</td>
                                            <td>@po.status</td>
                                            <td>@po.AmountDue</td>
                                            <td></td>
                                            <td>
                                                @* <button class="btn btn-sm btn-default edit-btn"
                                                        data-id="@customer.Id"
                                                        data-firstname="@customer.FirstName"
                                                        data-lastname="@customer.LastName"
                                                        data-mobile="@customer.MobileNumber"
                                                        data-city="@customer.City"
                                                        data-long="@customer.Long"
                                                        data-lat="@customer.Lat"
                                                        data-isactive="@customer.IsActive"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#AddOrEdit">
                                                    Edit
                                                </button> *@
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        <!-- /.card-body -->
                    </div>
                    <!-- /.card -->
                </div>
            </div>
            <!--end::Row-->
        </div>
        <!--end::Container-->
    </div>
    <!--end::App Content-->
</main>

@* Modal *@
<div class="modal fade" id="AddOrEdit" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <form id="form0">
            <input type="hidden" name="Id" id="Id" />

            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Left Column: Form Fields -->
                        <div class="col-md-12">
                            <table id="itemTable" class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>SKU </th>
                                        <th>Qty</th>
                                        <th>Price</th>
                                        <th>Image</th>
                                        <th>Total</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><input type="text" class="form-control sku" placeholder="SKU"></td>
                                        <td><input type="number" class="form-control qty" value="1" min="1"></td>
                                        <td><input type="number" class="form-control price" value="0" min="0"></td>
                                        <td></td>
                                        <td class="total">0</td>
                                        
                                    </tr>
                                </tbody>
                            </table>

                            <button type="button" class="btn btn-secondary" id="openAddRow">Add Item</button>
                            
                        </div>

                        
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" id="btnSave">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="addRow"  tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addItemModalLabel">Add Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Row for the two-column layout -->
                <div class="row">
                    <!-- Left Column: Form Fields -->
                    <div class="col-md-6">
                        <!-- SKU Search -->
                        <div class="mb-3">
                            <label>SKU</label>
                            <input type="text" id="skuSearch" class="form-control" placeholder="Type to search..." autocomplete="off">
                            <div id="skuSearching" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
                        </div>

                        <!-- Hidden field to store selected SKUId -->
                        <input type="hidden" id="purchaseOrderSKUId" name="SKUId" />

                        <!-- Quantity -->
                        <div class="mb-3">
                            <label>Quantity</label>
                            <input type="number" class="form-control" id="skuQuantity" name="Quantity" value="1" min="1" />
                        </div>

                        <!-- SubTotal -->
                        <div class="mb-3">
                            <label>SubTotal</label>
                            <input type="text" class="form-control" id="skuSubTotal" disabled />
                        </div>
                    </div>

                    <!-- Right Column: SKU Image -->
                    <div class="col-md-6">
                        <div class="text-center">
                            <img id="skuImagePreview" src="#" alt="Image Preview" style="max-width: 100%; height: auto; display: none; border: 1px solid #ddd; padding: 5px;" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="addItem" class="btn btn-primary">Save Item</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
   
    <script>


            $("#addItem").click(function () {
            var newRow = `
            <tr>
                <td><input type="text" class="form-control sku" placeholder="SKU"></td>
                <td><input type="number" class="form-control qty" value="1" min="1"></td>
                <td><input type="number" class="form-control price" value="0" min="0"></td>
                <td></td>
                <td class="total">0</td>
            </tr>`;
            $("#itemTable tbody").append(newRow);
        });

        

        
        $(document).on("input", ".qty, .price", function () {
            var row = $(this).closest("tr");
            var qty = parseFloat(row.find(".qty").val()) || 0;
            var price = parseFloat(row.find(".price").val()) || 0;
            row.find(".total").text((qty * price).toFixed(2));
        });

        document.getElementById("openAddRow").addEventListener("click", function () {
            var itemModal = new bootstrap.Modal(document.getElementById('addRow'));
            itemModal.show();
        });

        // 💾 Save PO via AJAX
        $("#btnSave").click(function (e) {
            e.preventDefault();
            // var supplierName = $("#supplierName").val().trim();
            // if (supplierName === "") {
            //     alert("Please enter supplier name.");
            //     return;
            // }
            
           
        let po = {
          CustomerId: "1",
         
          
          items: [
            {  skuid:1, quantity: 2, price: 500 },
            {  skuid:2, quantity: 2, price: 222 }
         
          ]
        };
            
            var items=[];
            $("#itemTable tbody tr").each(function () {
                var item = {
                    
                    Quantity: parseInt($(this).find(".qty").val()),
                    Price: parseFloat($(this).find(".price").val())
                };
               items.push(item);
              
            });

           
            $.ajax({
                url: '/PurchaseOrders/Create',
                type: 'POST',
               data: JSON.stringify(po),
                contentType: 'application/json',
                success: function (res) {
                    if (res.success) {
                        $("#result").html(
                            `<div class="alert alert-success">PO Created! Number: ${res.poNumber}</div>`
                        );
                        $("#form0")[0].reset();
                        $("#itemTable tbody").html("");
                    } else {
                        alert(res.message);
                    }
                },
                error: function () {
                    alert("Error saving purchase order.");
                }
            });
        });
    </script>
}